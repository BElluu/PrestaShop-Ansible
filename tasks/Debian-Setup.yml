---
- name: Update apt repo and cache
  apt: 
    update_cache: true 
    force_apt_get: true

- name: Upgrade all packages on servers
  apt: 
    upgrade: dist
    force_apt_get: true

- name: Ensure UnZip is installed
  apt:
    name: unzip

- name: Ensure PHP is installed
  apt:
    pkg:
      - libapache2-mod-php7.4
      - php7.4
      - php7.4-common
      - php7.4-curl
      - php7.4-gd
      - php7.4-imagick
      - php7.4-mbstring
      - php7.4-mysql
      - php7.4-json
      - php7.4-xsl
      - php7.4-intl
      - php7.4-zip

- name: Ensure Apache WebServer is installed
  apt:
    name: apache2

- name: Ensure rewrite module for apache is enabled
  apache2_module:
    state: present
    name: rewrite

- name: Restart Apache
  systemd:
    name: apache2
    state: restarted
    daemon_reload: true

- name: Ensure directory for PrestaShop exists
  file:
    path: /var/www/html/prestashop
    state: directory

- name: Ensure MySQL Server and Client are installed
  apt:
    pkg:
    - default-mysql-server
    - default-mysql-client
    state: present
  when: "{{ mysql_install == True}}"

- name: Ensure PyMySQL is installed
  apt: 
    name: python3-pymysql
    state: present

- name: Restart MySQL
  systemd:
    state: restarted
    name: mysql
  when: "{{ mysql_install == True}}"

- name: Ensure Database for PrestaShop is created
  mysql_db:
    name: "{{ mysql_prestashop_db }}"
    collation: utf8mb4_general_ci
    login_host: "{{ mysql_host }}"
    login_user: "{{ mysql_user }}"
    login_password: "{{ mysql_user_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: present

- name: Ensure user for PrestaShop database is created with privileges
  mysql_user:
    state: present
    name: "{{ mysql_prestashop_user }}"
    password: "{{ mysql_prestashop_password }}"
    priv: "{{ mysql_prestashop_db }}.*:ALL,GRANT"
    login_host: "{{ mysql_host }}"
    login_user: "{{ mysql_user }}"
    login_password: "{{ mysql_user_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock